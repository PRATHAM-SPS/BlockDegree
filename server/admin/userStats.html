<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.js"
      integrity="sha256-OztcN49BsVSoupBpIZaUwczM6+GLsXuA8IJF+W9SsBU="
      crossorigin="anonymous"
    ></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js"></script>
    <script src="//d3js.org/topojson.v1.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <style>
      body {
        font-family: "Lato", sans-serif;
      }

      table {
        font-size: 15px;
        width: 100%;
        text-align: center;
      }

      .sidenav {
        height: 100%;
        width: 200px;
        position: fixed;
        z-index: 1;
        top: 0;
        left: 0;
        background-color: #111;
        overflow-x: hidden;
        padding-top: 20px;
      }

      .sidenav div {
        padding: 6px 8px 6px 16px;
        text-decoration: none;
        font-size: 18px;
        color: white;
        display: block;
      }

      .sidenav div:hover {
        color: #f1f1f1;
        background-color: #818181;
        cursor: pointer;
      }

      th {
        white-space: nowrap;
        padding-top: 12px;
        padding-bottom: 12px;
        background-color: #4caf50;
        color: white;
      }
      tr:hover {
        background-color: #ddd;
      }

      #wrap-body {
        align-self: center;
        border: 1px solid black;
      }

      path {
        stroke: grey;
        stroke-width: 0.5px;
        fill: lightgrey;
      }

      #tooltip {
        text-align: left;
        padding: 16px;
        background-color: lightsalmon;
        border: 1px solid black;
        width: fit-content;
        opacity: 0;
        color: black;
        position: absolute;
      }

      /*
 * Footer
 */
      a:link {
        text-decoration: none;
      }

      a:visited {
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      .tableFooter {
        margin-top: 15px;
      }

      .footerSvg {
        width: 32px;
      }

      .main {
        margin-left: 230px;
        font-size: 28px;
        padding: 0px 10px;
      }

      @media screen and (max-height: 450px) {
        .sidenav {
          padding-top: 15px;
        }
        .sidenav div {
          font-size: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="sidenav">
      <div onclick="openPage('byAcntAcnts')">Accounts</div>
      <div onclick="openPage('byPromoCode')">Promocode</div>
      <div onclick="openPage('bySiteTraffic')">Traffic</div>
      <div onclick="openPage('byPayment')">Payment</div>
      <div onclick="openPage('byCertificates')">Certificates</div>
      <div onclick="openPage('byTrafficMap')">Traffic Map</div>
    </div>

    <div class="main">
      <section class="main-section">
        <div id="byAcntAcnts" class="tabcontent" style="display:none">
          <h2>Accounts</h2>
          <div>
            <button type="button" onclick="getUserLastQuater()">
              Get User Last Quater
            </button>
          </div>

          <div>
            <input
              type="number"
              id="days_last_created"
              placeholder="enter number of days"
            />
            <button type="button" onclick="getUsersLastNDays()">
              Created Last N Days
            </button>
          </div>

          <div>
            <input
              type="number"
              id="days_last_active"
              placeholder="enter number of days"
            />
            <button type="button" onclick="getUserLastNActive()">
              Active Last N Days
            </button>
          </div>
          <br />
          <span>Accounts Count:</span>
          <span id="acntCount"></span>
          <br />
          <div>
            <p id="mainTable"></p>
          </div>
        </div>
        <div id="byPromoCode" class="tabcontent" style="display:none">
          <h2>PromoCode</h2>
          <input
            id="codename_users"
            type="text"
            placeholder="code-name ( case sensitive )"
          />
          <button onclick="getUserListUsingCode()">Get List</button>
          &nbsp;&nbsp;or&nbsp;&nbsp;
          <input
            id="userByCode-n-days"
            type="number"
            placeholder="Last N Days"
          />
          <input id="" type="text" placeholder="code-name ( case sensitive )" />
          <button onclick="getUserListUsingCodeLastNDays()">Last N Days</button
          ><br />
          <button onclick="getAllCodes()">Get All Codes</button>
          &nbsp;&nbsp;or&nbsp;&nbsp;<input
            type="number"
            placeholder="Enter Last N Days"
            id="allCodes-n-days"
          /><button onclick="getAllCodeLastNDays()">
            Get All Codes - LastNDays
          </button>
          <br />
          <span>Promo Code Count:</span>
          <span id="promoCodeCount"></span>
          <br />
          <section id="promoCodeTable"></section>
        </div>
        <div id="byTrafficMap" class="tabcontent" style="display: none">
          <h1>Course Traffic Map</h1>
          <button onclick="loadMap('curri-blockchain-basic')">
            Map - Basic Curriculum
          </button>
          <button onclick="loadMap('curri-blockchain-advanced')">
            Map - Advanced Curriculum
          </button>
          <button onclick="loadMap('curri-blockchain-professional')">
            Map - Professional Curriculum</button
          ><br />
          <button onclick="loadMap('basic')">Map - Basic Course</button>
          <button onclick="loadMap('advanced')">Map - Advanced Course</button>
          <button onclick="loadMap('professional')">
            Map - Professional Course
          </button>
          <div id="wrap-body"></div>
          <div id="tooltip">
            Email: <span id="email" class="info"></span><br />
            Count: <span id="count" class="info"></span><br />
            City: <span id="city" class="info"></span><br />
            Region: <span id="region" class="info"></span><br />
            Country: <span id="country" class="info"></span><br />
            First Visit: <span id="firstVisit" class="info"></span><br />
            Last Visit: <span id="lastVisit" class="info"></span><br />
          </div>
        </div>
        <div id="bySiteTraffic" class="tabcontent" style="display:none">
          <h2>Traffic</h2>
          <button onclick="getAllVisits('curri-blockchain-basic')">
            Visited Curriculum Basic
          </button>
          &nbsp;&nbsp;&nbsp;or&nbsp;&nbsp;&nbsp;
          <input
            type="number"
            id="curri-blockchain-basic-n-days"
            placeholder="Last N Days"
          />
          <button onclick="getVisitsLastNDays('curri-blockchain-basic')">
            Curriculum Basic N Days</button
          ><br />
          <button onclick="getAllVisits('curri-blockchain-advanced')">
            Visited Curriculum Advanced</button
          >&nbsp;&nbsp;&nbsp;or&nbsp;&nbsp;&nbsp;
          <input
            type="number"
            id="curri-blockchain-advanced-n-days"
            placeholder="Last N Days"
          />
          <button onclick="getVisitsLastNDays('curri-blockchain-advanced')">
            Curriculum Advanced N Days</button
          ><br />
          <button onclick="getAllVisits('curri-blockchain-professional')">
            Visited Curriculum Professional
          </button>
          &nbsp;&nbsp;&nbsp;or&nbsp;&nbsp;&nbsp;
          <input
            type="number"
            id="curri-blockchain-professional-n-days"
            placeholder="Last N Days"
          />
          <button onclick="getVisitsLastNDays('curri-blockchain-professional')">
            Curriculum Professional N Days
          </button>
          <br />
          <button onclick="getAllVisits('basic')">
            Visited Course Basic
          </button>
          &nbsp;&nbsp;&nbsp;or&nbsp;&nbsp;&nbsp;
          <input type="number" id="basic-n-days" placeholder="Last N Days" />
          <button onclick="getVisitsLastNDays('basic')">
            Basic N Days</button
          ><br />
          <button onclick="getAllVisits('advanced')">
            Visited Course Advanced
          </button>
          &nbsp;&nbsp;&nbsp;or&nbsp;&nbsp;&nbsp;
          <input type="number" id="advanced-n-days" placeholder="Last N Days" />
          <button onclick="getVisitsLastNDays('advanced')">
            Advanced N Days</button
          ><br />
          <button onclick="getAllVisits('professional')">
            Visited Course Professional
          </button>
          &nbsp;&nbsp;&nbsp;or&nbsp;&nbsp;&nbsp;
          <input
            type="number"
            id="professional-n-days"
            placeholder="Last N Days"
          />
          <button onclick="getVisitsLastNDays('professional')">
            Professional N Days
          </button>
          <br />
          <span>Visit Count: </span><span id="visitCount"></span>
          <br />
          <section id="trafficTable"></section>
        </div>
        <div id="byPayment" class="tabcontent" style="display:none">
          <h2>Payment</h2>
          <button type="button" onclick="getAllUserPaymentList()">
            Get All Payments
          </button>
          <br />
          <span>Payment / Code Count: </span><span id="paymentCount"></span>
          <br />
          <section id="paymentTable"></section>
        </div>
        <div id="byCertificates" class="tabcontent" style="display:none">
          <h2>Certificates</h2>
          <button type="button" onclick="getAllUserCertificates()">
            Get Certificates By User</button
          >&nbsp;&nbsp;or&nbsp;&nbsp;<input
            type="number"
            id="userCert-n-days"
            placeholder="enter last N days"
          /><button type="button" onclick="getUserCertficatesLastNDays()">
            Get Certificates For Last n Days</button
          ><br />
          <button type="button" onclick="getCertificatesFromPromoCode()">
            Get Certificates With Payment Mode
          </button>
          <br />
          <span>Unique User Certificate Count: </span
          ><span id="certCount"></span>
          <span>Total Certificate Issued Count: </span
          ><span id="totCertisCount"></span>

          <br />
          <section id="certificatesTable"></section>
        </div>
      </section>
    </div>
  </body>

  <script>
    function openPage(pageName) {
      let allTabContent = document.getElementsByClassName("tabcontent");
      for (let i = 0; i < allTabContent.length; i++) {
        allTabContent[i].style.display = "none";
      }
      document.getElementById(pageName).style.display = "block";
    }

    function getUserLastQuater() {
      document.getElementById("mainTable").innerHTML = "";
      let acntCount = document.getElementById("acntCount");
      acntCount.innerHTML = "";
      $.ajax({
        method: "get",
        url: "/api/getUserLastQuater",
        success: result => {
          acntCount.innerHTML = result.length;
          let retHTML = '<table style="width:100%,font:15px">';
          retHTML += "<tr><th>EMAIL</th><th>CREATION TIME</th></tr>";
          for (let i = 0; i < result.length; i++) {
            retHTML += `<tr><td>${result[i].email}</td><td>${new Date(
              result[i].time
            )}</td></tr>`;
          }
          retHTML += "</table> ";
          document.getElementById("mainTable").innerHTML = retHTML;
        }
      });
    }

    function getUsersLastNDays() {
      document.getElementById("mainTable").innerHTML = "";
      let acntCount = document.getElementById("acntCount");
      acntCount.innerHTML = "";
      $.ajax({
        method: "post",
        url: "/api/lastNDaysCreated",
        data: { days: document.getElementById("days_last_created").value },
        success: result => {
          acntCount.innerHTML = result.length;
          let retHTML = '<table style="width:100%,font:15px">';
          retHTML += "<tr><th>EMAIL</th><th>CREATION TIME</th></tr>";
          for (let i = 0; i < result.length; i++) {
            retHTML += `<tr><td>${result[i].email}</td><td>${new Date(
              result[i].time
            )}</td></tr>`;
          }
          retHTML += "</table> ";
          document.getElementById("mainTable").innerHTML = retHTML;
        }
      });
    }

    function getUserLastNActive() {
      document.getElementById("mainTable").innerHTML = "";
      let acntCount = document.getElementById("acntCount");
      acntCount.innerHTML = "";
      $.ajax({
        method: "post",
        url: "/api/lastNDaysActive",
        data: { days: document.getElementById("days_last_active").value },
        success: result => {
          acntCount.innerHTML = result.length;
          let retHTML = '<table style="width:100%,font:15px">';
          retHTML += "<tr><th>EMAIL</th><th>LAST ACTIVE TIME</th></tr>";
          for (let i = 0; i < result.length; i++) {
            retHTML += `<tr><td>${result[i].email}</td><td>${new Date(
              result[i].time
            )}</td></tr>`;
          }
          retHTML += "</table> ";
          document.getElementById("mainTable").innerHTML = retHTML;
        }
      });
    }

    function getUserListUsingCode() {
      let codeName = document.getElementById("codename_users").value;
      let promoCodeCount = document.getElementById("promoCodeCount");
      // console.log(codeName);
      let promoCodeTable = document.getElementById("promoCodeTable");
      if (codeName != undefined && codeName != null && codeName != "") {
        $.ajax({
          method: "post",
          url: "/api/getUserListUsingCode",
          data: { codeName: codeName },
          success: result => {
            // console.log(result);
            if (!result.status) {
              alert(`Error:${result.error}`);
            } else {
              let retHtml = "<table>";
              let userArr = result.users;
              promoCodeCount.innerHTML = userArr.length - 1;
              if (result.restricted) {
                retHtml +=
                  "<tr><th>Email</th><th>Count</th><th>Created</th><th>Last Used</th></tr>";
                for (let i = 1; i < userArr.length; i++) {
                  retHtml += `<tr><td>${userArr[i].email}</td><td>${
                    userArr[i].count
                  }</td><td>${new Date(userArr[i].created)}</td><td>${new Date(
                    userArr[i].lastUsed
                  )}</td></tr>`;
                }
              } else {
                retHtml +=
                  "<tr><th>Email</th><th>Count</th><th>First Used</th><th>Last Used</th></tr>";
                for (let i = 1; i < userArr.length; i++) {
                  retHtml += `<tr><td>${userArr[i].email}</td><td>${
                    userArr[i].count
                  }</td><td>${new Date(
                    userArr[i].firstUsed
                  )}</td><td>${new Date(userArr[i].lastUsed)}</td></tr>`;
                }
              }
              promoCodeTable.innerHTML = retHtml + "</table>";
            }
          },
          error: err => {
            alert(`Error: ${err}`);
          }
        });
      }
    }

    function getUserListUsingCodeLastNDays() {
      let codeName = document.getElementById("codename_users").value;
      let promoCodeCount = document.getElementById("promoCodeCount");
      let n = document.getElementById("userByCode-n-days").value;
      let nMilliSecs = parseFloat(n.trim()) * 24 * 60 * 60 * 1000;
      // console.log(codeName);
      let promoCodeTable = document.getElementById("promoCodeTable");
      if (codeName != undefined && codeName != null && codeName != "") {
        let todayStart = new Date();
        todayStart.setHours(0);
        todayStart.setMinutes(0);
        todayStart.setSeconds(0);
        $.ajax({
          method: "post",
          url: "/api/getUserListUsingCode",
          data: { codeName: codeName },
          success: result => {
            // console.log(result);
            if (!result.status) {
              alert(`Error:${result.error}`);
            } else {
              let retHtml = "<table>";
              let userArr = result.users;
              let codeCount = 0;
              if (result.restricted) {
                retHtml +=
                  "<tr><th>Email</th><th>Count</th><th>Created</th><th>Last Used</th></tr>";
                for (let i = 1; i < userArr.length; i++) {
                  if (
                    todayStart - parseFloat(userArr[i].lastUsed) <
                    nMilliSecs
                  ) {
                    codeCount++;
                    retHtml += `<tr><td>${userArr[i].email}</td><td>${
                      userArr[i].count
                    }</td><td>${new Date(
                      userArr[i].created
                    )}</td><td>${new Date(userArr[i].lastUsed)}</td></tr>`;
                  }
                }
              } else {
                retHtml +=
                  "<tr><th>Email</th><th>Count</th><th>First Used</th><th>Last Used</th></tr>";
                for (let i = 1; i < userArr.length; i++) {
                  if (
                    todayStart - parseFloat(userArr[i].lastUsed) <
                    nMilliSecs
                  ) {
                    codeCount++;
                    retHtml += `<tr><td>${userArr[i].email}</td><td>${
                      userArr[i].count
                    }</td><td>${new Date(
                      userArr[i].firstUsed
                    )}</td><td>${new Date(userArr[i].lastUsed)}</td></tr>`;
                  }
                }
              }
              promoCodeTable.innerHTML = retHtml + "</table>";
              promoCodeCount.innerHTML = codeCount;
            }
          },
          error: err => {
            alert(`Error: ${err}`);
          }
        });
      }
    }

    function getAllCodes() {
      let promoCodeTable = document.getElementById("promoCodeTable");
      promoCodeTable.innerHTML = "";
      $.ajax({
        method: "get",
        url: "/api/getAllCodes",
        success: result => {
          let allCodes = result.codes;
          promoCodeCount.innerHTML = allCodes.length;
          let retHTML = '<table style="width: 100%;">';
          retHTML +=
            "<tr><th>CodeName</th><th>Used Count</th><th>User Count</th><th>Active</th><th>Restricted</th><th>Created</th><th>Last Used</th></tr>";
          for (let i = 0; i < allCodes.length; i++) {
            let createdDate = new Date(parseFloat(allCodes[i].created));
            let lastUsedDate = new Date(parseFloat(allCodes[i].lastUsed));
            retHTML += `<tr><td>${allCodes[i].codeName}</td><td>${
              allCodes[i].count
            }</td><td>${allCodes[i].users.length - 1}</td><td>${
              allCodes[i].status
            }</td><td>${
              allCodes[i].restricted
            }</td><td>${createdDate.getDate()}/${createdDate.getMonth() +
              1}/${lastUsedDate.getFullYear()}</td><td>${lastUsedDate.getDate()}/${lastUsedDate.getMonth() +
              1}/${lastUsedDate.getFullYear()}</td></tr>`;
          }
          retHTML += "</table>";
          promoCodeTable.innerHTML = retHTML;
        },
        error: err => {
          alert(`Error: ${err}`);
        }
      });
    }

    function getAllCodeLastNDays() {
      let promoCodeTable = document.getElementById("promoCodeTable");
      promoCodeTable.innerHTML = "";
      $.ajax({
        method: "get",
        url: "/api/getAllCodes",
        success: result => {
          let allCodes = result.codes;
          let codeCount = 0;
          let n = document.getElementById("allCodes-n-days").value;
          let nMilliSecs = parseFloat(n.trim()) * 24 * 60 * 60 * 1000;
          let retHTML = '<table style="width: 100%;">';
          let todayStart = new Date();
          todayStart.setHours(0);
          todayStart.setMinutes(0);
          todayStart.setSeconds(0);
          retHTML +=
            "<tr><th>CodeName</th><th>Used Count</th><th>User Count</th><th>Active</th><th>Restricted</th><th>Created</th><th>Last Used</th></tr>";
          for (let i = 0; i < allCodes.length; i++) {
            if (todayStart - parseFloat(allCodes[i].lastUsed) < nMilliSecs) {
              codeCount++;
              let createdDate = new Date(parseFloat(allCodes[i].created));
              let lastUsedDate = new Date(parseFloat(allCodes[i].lastUsed));
              retHTML += `<tr><td>${allCodes[i].codeName}</td><td>${
                allCodes[i].count
              }</td><td>${allCodes[i].users.length - 1}</td><td>${
                allCodes[i].status
              }</td><td>${
                allCodes[i].restricted
              }</td><td>${createdDate.getDate()}/${createdDate.getMonth() +
                1}/${lastUsedDate.getFullYear()}</td><td>${lastUsedDate.getDate()}/${lastUsedDate.getMonth() +
                1}/${lastUsedDate.getFullYear()}</td></tr>`;
            }
          }
          retHTML += "</table>";
          promoCodeCount.innerHTML = codeCount;
          promoCodeTable.innerHTML = retHTML;
        },
        error: err => {
          alert(`Error: ${err}`);
        }
      });
    }

    function getAllVisits(content) {
      let trafficTable = document.getElementById("trafficTable");
      let visitCount = document.getElementById("visitCount");
      visitCount.innerHTML = "";
      trafficTable.innerHTML = "";
      let retHTML = "<table>";
      retHTML +=
        "<tr><th>Email</th><th>IP Address</th><th>Count</th><th>First Visit</th><th>Last Visit</th></tr>";
      $.ajax({
        method: "post",
        url: "/api/getVisits",
        data: { content: content },
        success: result => {
          if (result.status) {
            visitCount.innerHTML = result.visits.length;
            for (let i = 0; i < result.visits.length; i++) {
              retHTML += `<tr><td>${
                result.visits[i].email == undefined ||
                result.visits[i].email == ""
                  ? "NA"
                  : result.visits[i].email
              }</<td><td>${
                result.visits[i].ip == undefined || result.visits[i].ip == ""
                  ? "NA"
                  : result.visits[i].ip
              }</<td><td>${result.visits[i].count}</<td><td>${new Date(
                parseFloat(result.visits[i].firstVisit)
              )}</<td><td>${new Date(
                parseFloat(result.visits[i].lastVisit)
              )}</<td></tr>`;
            }
            retHTML += "</table>";
            // console.log(retHTML);
            trafficTable.innerHTML = retHTML;
          }
        },
        error: err => {
          alert(`Error: ${err}`);
        }
      });
    }

    function getVisitsLastNDays(content) {
      let trafficTable = document.getElementById("trafficTable");
      let visitCount = document.getElementById("visitCount");
      let n = document.getElementById(`${content}-n-days`).value;
      let nToMilliSec;
      let todayStart = new Date();
      todayStart.setHours(0);
      todayStart.setMinutes(0);
      todayStart.setSeconds(0);
      if (n.trim() !== "") {
        nToMilliSec = parseFloat(n) * 24 * 60 * 60 * 1000;
      }
      visitCount.innerHTML = "";
      trafficTable.innerHTML = "";
      let retHTML = "<table>";
      retHTML +=
        "<tr><th>Email</th><th>IP Address</th><th>Count</th><th>First Visit</th><th>Last Visit</th></tr>";
      $.ajax({
        method: "post",
        url: "/api/getVisits",
        data: { content: content },
        success: result => {
          if (result.status) {
            let count = 0;
            for (let i = 0; i < result.visits.length; i++) {
              if (
                todayStart - parseFloat(result.visits[i].lastVisit) <
                nToMilliSec
              ) {
                count++;
                retHTML += `<tr><td>${
                  result.visits[i].email == undefined ||
                  result.visits[i].email == ""
                    ? "NA"
                    : result.visits[i].email
                }</<td><td>${
                  result.visits[i].ip == undefined || result.visits[i].ip == ""
                    ? "NA"
                    : result.visits[i].ip
                }</<td><td>${result.visits[i].count}</<td><td>${new Date(
                  parseFloat(result.visits[i].firstVisit)
                )}</<td><td>${new Date(
                  parseFloat(result.visits[i].lastVisit)
                )}</<td></tr>`;
              }
            }
            visitCount.innerHTML = count + "";
            retHTML += "</table>";
            // console.log(retHTML);
            trafficTable.innerHTML = retHTML;
          }
        },
        error: err => {
          alert(`Error: ${err}`);
        }
      });
    }

    function getAllUserPaymentList() {
      let paymentTable = document.getElementById("paymentTable");
      let paymentCount = document.getElementById("paymentCount");
      paymentCount.innerHTML = "";
      let retHTML = "<table>";
      retHTML +=
        '<tr><th rowspan="2">Email</th><th colspan="2">Codes</th><th colspan="2">Payment</th></tr><tr><th>Code Name</th><th>Count</th><th>Course ID</th><th>Count</th></tr>';
      $.ajax({
        method: "get",
        url: "/api/getAllUserPaymentList",
        success: result => {
          // console.log("result: ", result);
          let data = result.data;
          let codeKeys = [],
            paymentKeys = [],
            totCode = 0,
            totPayment = 0;
          paymentCount.innerHTML = result.data.length;
          for (let i = 0; i < data.length; i++) {
            if (data[i].codes != undefined) {
              codeKeys = Object.keys(data[i].codes);
              totCode = codeKeys.length;
            } else {
              (codeKeys = []), (totCode = 0);
            }
            if (data[i].payment != undefined) {
              paymentKeys = Object.keys(data[i].payment);
              totPayment = paymentKeys.length;
            } else {
              (paymentKeys = []), (totPayment = 0);
            }
            let rowSpan = totCode > totPayment ? totCode : totPayment;
            // console.log("Current Data: ", data[i]);
            // console.log(`Tot Code: ${totCode}`);
            // console.log(`Tot Payment: ${totPayment}`);
            retHTML += `<tr><td rowspan="${rowSpan}">${data[i].email}</td><td>${
              totCode > 0 ? codeKeys[0] : "NA"
            }</td><td>${
              totCode > 0 ? data[i].codes[codeKeys[0]] : "NA"
            }</td><td>${totPayment > 0 ? paymentKeys[0] : "NA"}</td><td>${
              totPayment > 0 ? data[i].payment[paymentKeys[0]] : "NA"
            }</td></tr>`;
            for (let maxIndex = 1; maxIndex < rowSpan; maxIndex++) {
              // fillout the rowspan
              // console.log(
              //   `Iteration ${maxIndex} code exists : ${totCode >=
              //     maxIndex} paymentIndex : ${totPayment >= maxIndex} `
              // );
              retHTML += `<tr><td>${
                totCode - 1 >= maxIndex ? codeKeys[maxIndex] : "NA"
              }</td><td>${
                totCode - 1 >= maxIndex
                  ? data[i].codes[codeKeys[maxIndex]]
                  : "NA"
              }</td><td>${
                totPayment - 1 >= maxIndex ? paymentKeys[maxIndex] : "NA"
              }</td><td>${
                totPayment - 1 >= maxIndex
                  ? data[i].payment[paymentKeys[maxIndex]]
                  : "NA"
              }</td></tr>`;
            }
          }
          retHTML += "</html>";
          paymentTable.innerHTML = retHTML;
        }
      });
    }

    function getAllUserCertificates() {
      let certificatesTable = document.getElementById("certificatesTable");
      let certificateCount = document.getElementById("certCount");
      let totCertisCount = document.getElementById("totCertisCount");
      certificateCount.innerHTML = "";
      let retHTML = "<table class='certificateTab'";
      retHTML +=
        "<tr><th rowspan='2'>Email</th><th colspan='4' >Certificates</th></tr><tr><th>Course Name</th><th>Client Hash</th><th>Document Hash</th><th>Timestamp</th></tr>";
      $.ajax({
        method: "get",
        url: "/api/getAllUserCertificates",
        success: result => {
          if (!result.status) {
            alert(`Error: ${result.error}`);
          } else {
            // console.log(result);
            let data = result.users;
            let totCertis = 0;
            certificateCount.innerHTML = data.length;
            for (let i = 0; i < data.length; i++) {
              let currentUser = data[i];
              let currentCertificates = currentUser.examData.certificateHash;
              let rowSpan = currentCertificates.length;
              retHTML += `<tr><td >${currentUser.email}</td><td>${
                currentCertificates[1].examType
              }</td><td>${currentCertificates[1].clientHash}</td><td>${
                currentCertificates[1].headlessHash
              }</td><td>${new Date(
                parseFloat(currentCertificates[1].timestamp)
              )}</td></tr>`;
              totCertis++;
              for (let j = 2; j < rowSpan; j++) {
                totCertis++;
                retHTML += `<tr><td > -- || -- </td><td>${
                  currentCertificates[j].examType
                }</td><td>${currentCertificates[j].clientHash}</td><td>${
                  currentCertificates[1].headlessHash
                }</td><td>${new Date(
                  parseFloat(currentCertificates[j].timestamp)
                )}</td></tr>`;
              }
            }
            retHTML += "</table>";
            certificatesTable.innerHTML = retHTML;
            totCertisCount.innerHTML = totCertis;
          }
        },
        error: err => {
          alert(`Error: ${err}`);
        }
      });
    }

    function getUserCertficatesLastNDays() {
      let certificatesTable = document.getElementById("certificatesTable");
      let certificateCount = document.getElementById("certCount");
      let totCertisCount = document.getElementById("totCertisCount");
      let n = document.getElementById("userCert-n-days").value;
      let nMilliSecs = parseFloat(n.trim()) * 24 * 60 * 60 * 1000;
      let todayStart = new Date();
      todayStart.setHours(0);
      todayStart.setMinutes(0);
      todayStart.setSeconds(0);
      certificateCount.innerHTML = "";
      let retHTML = "<table class='certificateTab'";
      retHTML +=
        "<tr><th rowspan='2'>Email</th><th colspan='4' >Certificates</th></tr><tr><th>Course Name</th><th>Client Hash</th><th>Document Hash</th><th>Timestamp</th></tr>";
      $.ajax({
        method: "get",
        url: "/api/getAllUserCertificates",
        success: result => {
          if (!result.status) {
            alert(`Error: ${result.error}`);
          } else {
            // console.log(result);
            let data = result.users;
            let totCertis = 0;
            certificateCount.innerHTML = data.length;
            for (let i = 0; i < data.length; i++) {
              let currentUser = data[i];
              let currentCertificates = currentUser.examData.certificateHash;
              let rowSpan = currentCertificates.length;
              if (
                todayStart - parseFloat(currentCertificates[1].timestamp) <
                nMilliSecs
              ) {
                retHTML += `<tr><td >${currentUser.email}</td><td>${
                  currentCertificates[1].examType
                }</td><td>${currentCertificates[1].clientHash}</td><td>${
                  currentCertificates[1].headlessHash
                }</td><td>${new Date(
                  parseFloat(currentCertificates[1].timestamp)
                )}</td></tr>`;
                totCertis++;
              }
              for (let j = 2; j < rowSpan; j++) {
                if (
                  todayStart - parseFloat(currentCertificates[j].timestamp) <
                  nMilliSecs
                ) {
                  totCertis++;
                  retHTML += `<tr><td > -- || -- </td><td>${
                    currentCertificates[j].examType
                  }</td><td>${currentCertificates[j].clientHash}</td><td>${
                    currentCertificates[1].headlessHash
                  }</td><td>${new Date(
                    parseFloat(currentCertificates[j].timestamp)
                  )}</td></tr>`;
                }
              }
            }
            retHTML += "</table>";
            certificatesTable.innerHTML = retHTML;
            totCertisCount.innerHTML = totCertis;
          }
        },
        error: err => {
          alert(`Error: ${err}`);
        }
      });
    }

    function getCertificatesFromPromoCode() {
      let certificatesTable = document.getElementById("certificatesTable");
      let certificateCount = document.getElementById("certCount");
      let totCertisCount = document.getElementById("totCertisCount");
      certificateCount.innerHTML = "";
      let allUserCertis = [],
        allUserPayment = [];
      let retHTML = "<table class='certificateTab'";
      retHTML +=
        "<tr><th rowspan='2'>Email</th><th colspan='4'>Payment</th><th colspan='4' >Certificates</th></tr><tr><th>Code Name</th><th>Count</th><th>Course ID</th><th>Count</th><th>Course Name</th><th>Client Hash</th><th>Document Hash</th><th>Timestamp</th></tr>";
      $.ajax({
        method: "get",
        url: "/api/getAllUserCertificates",
        success: res => {
          if (!res.status) {
            alert(`Error: ${res.error}`);
          } else {
            allUserCertis = res.users;
            $.ajax({
              method: "get",
              url: "/api/getAllUserPaymentList",
              success: result => {
                // console.log("result: ", result);
                allUserPayment = result.data;
                let codeKeys = [],
                  paymentKeys = [],
                  totCode = 0,
                  totPayment = 0;
                // const totRows = allUserCertis.length > allUserPayment.length ? allUserCertis.length : allUserPayment.length;
                for (let i = 0; i < allUserCertis.length; i++) {
                  const currentUser = allUserCertis[i];
                  const userPaymentTuple = findUser(
                    allUserPayment,
                    currentUser.email
                  );
                  if (userPaymentTuple.codes != undefined) {
                    codeKeys = Object.keys(userPaymentTuple.codes);
                    totCode = codeKeys.length;
                  } else {
                    (codeKeys = []), (totCode = 0);
                  }
                  if (userPaymentTuple.payment != undefined) {
                    paymentKeys = Object.keys(userPaymentTuple.payment);
                    totPayment = paymentKeys.length;
                  } else {
                    (paymentKeys = []), (totPayment = 0);
                  }
                  const paymentRowSpan =
                    totCode > totPayment ? totCode : totPayment;
                  let currentCertificates =
                    currentUser.examData.certificateHash;
                  const certisRowSpan = currentCertificates.length;
                  const currRowSpan =
                    paymentRowSpan > certisRowSpan
                      ? paymentRowSpan
                      : certisRowSpan;
                  retHTML += `<tr><td>${currentUser.email}</td><td>${
                    totCode > 0 ? codeKeys[0] : "NA"
                  }</td><td>${
                    totCode > 0 ? userPaymentTuple.codes[codeKeys[0]] : "NA"
                  }</td><td>${totPayment > 0 ? paymentKeys[0] : "NA"}</td><td>${
                    totPayment > 0
                      ? userPaymentTuple.payment[paymentKeys[0]]
                      : "NA"
                  }</td><td>${currentCertificates[1].examType}</td><td>${
                    currentCertificates[1].clientHash
                  }</td><td>${
                    currentCertificates[1].headlessHash
                  }</td><td>${new Date(
                    parseFloat(currentCertificates[1].timestamp)
                  )}</td><tr>`;
                  let remainingCertis = certisRowSpan - 2;
                  let remainingCodes = totCode - 1;
                  let remainingPayment = totPayment - 1;
                  // max out of three
                  let maxRemainingSpan =
                    remainingCertis > remainingCodes
                      ? remainingCertis > remainingPayment
                        ? remainingCertis
                        : remainingPayment
                      : remainingCodes > remainingPayment
                      ? remainingCodes
                      : remainingPayment;
                  // 2 onwards for certificates & 1 onwards for code & payment
                  let offSetCode = 1,
                    offSetPayment = 1,
                    offSetCertis = 2;
                  for (let j = 0; j < maxRemainingSpan; j++) {
                    retHTML += `<tr><td>-- || --</td><td>${
                      remainingCodes > 0 ? codeKeys[j + offSetCode] : "NA"
                    }</td><td>${
                      remainingCodes > 0
                        ? userPaymentTuple.codes[codeKeys[j + offSetCode]]
                        : "NA"
                    }</td>
          <td>${
            remainingPayment > 0 ? paymentKeys[j + offSetPayment] : "NA"
          }</td><td>${
                      remainingPayment > 0
                        ? userPaymentTuple.payment[
                            paymentKeys[j + offSetPayment]
                          ]
                        : "NA"
                    }</td>
          <td>${
            currentCertificates[j + offSetCertis] !== undefined
              ? currentCertificates[j + offSetCertis].examType
              : "NA"
          }</td><td>${
                      currentCertificates[j + offSetCertis] !== undefined
                        ? currentCertificates[j + offSetCertis].clientHash
                        : "NA"
                    }</td><td>${
                      currentCertificates[j + offSetCertis] !== undefined
                        ? currentCertificates[j + offSetCertis].headlessHash
                        : "NA"
                    }</td><td>${
                      currentCertificates[j + offSetCertis] !== undefined
                        ? new Date(
                            parseFloat(
                              currentCertificates[j + offSetCertis].timestamp
                            )
                          )
                        : "NA"
                    }</td></tr>`;
                    if (remainingCodes > 0) remainingCodes--;
                    if (remainingPayment > 0) remainingPayment--;
                    if (remainingCertis > 0) remainingCertis--;
                  }
                }
                certificatesTable.innerHTML = retHTML;
              }
            });
          }
        },
        error: err => {
          alert(`Error: ${err}`);
        }
      });
    }

    function loadMap(visitPage) {
      // let regions = [];
      // Width and Height of the whole visualization
      $("#wrap-body").html("");
      var w = 1000;
      var h = 480;
      //D3 has some internal functionality that can turn GeoJSON data into screen coordinates based on the projection you set. This is not unlike other libraries such as Leaflet, but the result is much more open-ended, not constrained to shapes on a tiled Mercator map.1 So, yes, D3 supports projections.
      var projection = d3.geo.equirectangular();
      // Create GeoPath function that uses built-in D3 functionality to turn
      // lat/lon coordinates into screen coordinates
      var path = d3.geo.path().projection(projection);
      //add the following to create our SVG canvas.
      var svg = d3
        .select("#wrap-body")
        .append("svg")
        .attr("width", w)
        .attr("height", h);
      svg
        .append("rect")
        .attr("width", w)
        .attr("height", h)
        .attr("fill", "white");
      // Append empty placeholder g element to the SVG
      // g will contain geometry elements
      var g = svg.append("g");

      //add a call to d3.json to load the TopoJSON file
      //so it loads into our visualization
      d3.json("https://d3js.org/world-50m.v1.json", async function(
        error,
        data
      ) {
        if (error) console.error(error);
        g.append("path")
          .datum(topojson.feature(data, data.objects.countries))
          .attr("d", path);

        //create the zoom effect
        var zoom = d3.behavior.zoom().on("zoom", function() {
          g.attr(
            "transform",
            "translate(" +
              d3.event.translate.join(",") +
              ")scale(" +
              d3.event.scale +
              ")"
          );
          g.selectAll("path").attr("d", path.projection(projection));
        });
        svg.call(zoom);

        // Load the data from the json file
        // d3.json(locatio, function(error, data) {
        data = await loadDataFromIP(visitPage);
        console.log(data);
        if (error) console.error(error);
        // for (let itr = 0; itr < data.features.length; itr++) {
        //   let existingIndex = isNewRegion(
        //     regions,
        //     data.features[itr].properties.region
        //   );
        //   if (existingIndex !== -1) {
        //     // is not new region, assign existing color
        //     data.features[itr].color = regions[existingIndex].color;
        //     continue;
        //   }
        //   // generate new color, add to region arr, set color
        //   let newColor = getRandomColor();
        //   regions.push({ name: data.features[itr].region, color: newColor });
        //   data.features[itr].color = newColor;
        // }

        var locations = data.features;
        console.log("Location: ", locations);
        // we will pass our data (the TopoJSON) as an argument, then create SVG elements using a classic D3 append. Selecting all paths, the TopoJSON is bound in the data method. From here, we can perform work on each element.

        // locations.map(function(d) {
        //   // Create an object for holding dataset
        //   hue += 0.36; // Create property for each circle, give it value from color
        //   d.color = "hsl(" + hue + ", 100%, 50%)";
        // });

        // Classic D3... Select non-existent elements, bind the data, append the elements, and apply attributes
        g.selectAll("circle")
          .data(locations)
          .enter()
          .append("circle") //show the circles
          .attr("cx", function(d) {
            if (d.geometry) {
              return projection([
                d.geometry.coordinates[0],
                d.geometry.coordinates[1]
              ])[0];
            }
          })
          .attr("cy", function(d) {
            if (d.geometry) {
              return projection([
                d.geometry.coordinates[0],
                d.geometry.coordinates[1]
              ])[1];
            }
          })
          .attr("r", function(d) {
            return Math.pow(10, 1 / 9); // static point size
          })
          .style("fill", function(d) {
            //Use the Color Function to set the Fill Value for each circle
            return d.properties.color;
          })

          //Next, we need to write two pieces of code, one that listens for when the value of the tooltip changes, and one that updates the SVG elements.
          //We are going to use some D3 code to listen for an input change on the tooltip elements

          //Add Event Listeners | mouseover
          .on("mouseover", function(d) {
            d3.select(this).style("fill", "black");
            d3.select("#email").text(d.properties.email);
            d3.select("#count").text(d.properties.count);
            d3.select("#country").text(d.properties.country);
            d3.select("#region").text(d.properties.region);
            d3.select("#city").text(d.properties.city);
            d3.select("#firstVisit").text(d.properties.firstVisit);
            d3.select("#lastVisit").text(d.properties.lastVisit);

            d3.select("#tooltip")
              .style("left", d3.event.pageX + 20 + "px")
              .style("top", d3.event.pageY - 80 + "px")
              .style("display", "block")
              .style("opacity", 0.8);
          })
          //Add Event Listeners | mouseout
          .on("mouseout", function(d) {
            d3.select(this).style("fill", d.properties.color);
            d3.select("#tooltip").style("display", "none");
          });
      });
      // });
    }

    function getRandomColor() {
      var letters = "0123456789ABCDEF";
      var color = "#";
      for (var i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }

    function isNewRegion(arr, regName) {
      console.log(arr, regName);
      for (let i = 0; i < arr.length; i++) {
        if (arr[i].name === regName) {
          return i;
        }
      }
      return -1;
    }

    function findUser(arr, email) {
      for (let i = 0; i < arr.length; i++) {
        if (email === arr[i].email) {
          return arr[i];
        }
      }
      return false;
    }

    async function loadDataFromIP(visitPage) {
      let result = await $.ajax({
        method: "post",
        url: "/api/getVisits",
        data: { content: visitPage }
      });
      let retData = {
        type: "FeatureCollection",
        features: [],
        crs: {
          type: "name",
          properties: {
            name: "urn:ogc:def:crs:OGC:1.3:CRS84"
          }
        }
      };
      if (result.status) {
        let featuredData = [];
        let regions = [];
        for (let i = 0; i < result.visits.length; i++) {
          console.log(i);
          if (!result.visits[i].ip) continue;
          let ip = result.visits[i].ip.trim();
          if (ip !== undefined) {
            // generate new or fetch color based on the region
            let color = "";
            let existingIndex = isNewRegion(regions, result.visits[i].region);
            if (existingIndex !== -1) {
              // is not new region, assign existing color
              color = regions[existingIndex].color;
            } else {
              // generate new color, add to region arr, set color
              let newColor = getRandomColor();
              while (newColor == "#D3D3D3") {
                newColor = getRandomColor();
              }
              regions.push({
                name: result.visits[i].region,
                color: newColor
              });
              color = newColor;
            }
            let currCreatedDate = new Date(
              parseFloat(result.visits[i].firstVisit)
            );
            let currLastDate = new Date(parseFloat(result.visits[i].lastVisit));
            featuredData.push({
              type: "Feature",
              geometry: {
                type: "Point",
                coordinates: [
                  parseFloat(result.visits[i].coordinates[1]),
                  parseFloat(result.visits[i].coordinates[0])
                ]
              },
              properties: {
                email:
                  result.visits[i].email !== undefined
                    ? result.visits[i].email
                    : "",
                region: result.visits[i].region,
                country: result.visits[i].country,
                city: result.visits[i].city,
                count: result.visits[i].count,
                firstVisit: `${currCreatedDate.getDate()}/${currCreatedDate.getUTCMonth() +
                  1}/${currCreatedDate.getFullYear()}`,
                lastVisit: `${currLastDate.getDate()}/${currLastDate.getUTCMonth() +
                  1}/${currLastDate.getFullYear()}`,
                color: color
              }
            });

            // $.ajax({ async: true });
          }
        }
        retData.features = featuredData;
        console.log("Return data: ", retData);
        return retData;
      }
    }
  </script>
</html>
